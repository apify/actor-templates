name: Update Templates

on:
  workflow_dispatch:
    inputs:
      base_image:
        description: 'Base image to update'
        required: true
        type: string
      module_version:
        description: 'Playwright or Puppeteer version'
        required: false
        type: string
      default_runtime_version:
        description: 'Default runtime version (example: 24 for node, 3.13 for python)'
        required: false
        type: string
  repository_dispatch:
    types:
      - update-templates

env:
  BASE_IMAGE_RAW: ${{ github.event.client_payload.base_image || inputs.base_image }}
  RAW_BRANCH_NAME: ci/${{ github.event.client_payload.base_image || inputs.base_image }}
  BASE_IMAGE: ${{ github.event.client_payload.base_image || inputs.base_image }}
  DEFAULT_RUNTIME_VERSION: ${{ github.event.client_payload.default_runtime_version || inputs.default_runtime_version }}
  MODULE_VERSION: ${{ github.event.client_payload.module_version || inputs.module_version }}

jobs:
  update-templates:
    runs-on: ubuntu-latest

    steps:
      - name: Sanitize base image
        id: branch-name
        run: |
          echo "BRANCH_NAME=$(echo '${{ env.RAW_BRANCH_NAME }}' | sed 's/,/_/g')" >> $GITHUB_OUTPUT
          echo "BASE_IMAGE_FORMATTED=$(echo '${{ env.BASE_IMAGE_RAW }}' | sed 's/,/, /g')" >> $GITHUB_OUTPUT

      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          token: ${{ secrets.APIFY_SERVICE_ACCOUNT_GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Check and manage branch
        run: |
          # Fetch all branches
          git fetch origin

          # Check if branch exists on remote
          if git ls-remote --heads origin "${{ steps.branch-name.outputs.BRANCH_NAME }}" | grep -q "${{ steps.branch-name.outputs.BRANCH_NAME }}"; then
            echo "Branch ${{ steps.branch-name.outputs.BRANCH_NAME }} exists, checking it out and resetting to origin/master"
            git checkout "${{ steps.branch-name.outputs.BRANCH_NAME }}"
            git reset --hard origin/master
          else
            echo "Branch ${{ steps.branch-name.outputs.BRANCH_NAME }} does not exist, creating it"
            git checkout -b "${{ steps.branch-name.outputs.BRANCH_NAME }}"
          fi

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: 24

      - name: Run update script
        env:
          BASE_IMAGE: ${{ env.BASE_IMAGE_RAW }}
          DEFAULT_RUNTIME_VERSION: ${{ env.DEFAULT_RUNTIME_VERSION }}
          MODULE_VERSION: ${{ env.MODULE_VERSION }}
        run: node ./scripts/actions/update-templates.mts

      - name: Commit and push changes
        id: commit-and-push
        run: |
          # Check if there are any changes
          if git diff --quiet && git diff --cached --quiet; then
            echo "No changes to commit"
          else
            git add -A
            git commit -m "chore: Update templates for base image: ${{ env.BASE_IMAGE_RAW }}"
            echo "committed=true" >> $GITHUB_OUTPUT
          fi

          # Force push the branch
          git push --force origin "${{ steps.branch-name.outputs.BRANCH_NAME }}"

      - name: Wait for CI
        id: wait-for-ci
        env:
          GH_TOKEN: ${{ secrets.APIFY_SERVICE_ACCOUNT_GITHUB_TOKEN }}
        if: steps.commit-and-push.outputs.committed == 'true'
        run: |
          COMMIT_SHA=$(git rev-parse HEAD)
          BRANCH="${{ steps.branch-name.outputs.BRANCH_NAME }}"
          echo "Waiting for CI run on commit $COMMIT_SHA (branch: $BRANCH)"

          # Poll for the workflow run matching our exact commit
          RUN_ID=""
          for i in $(seq 1 30); do
            echo "Attempt $i/30: looking for CI run..."
            RUN_ID=$(gh run list \
              --workflow=lint_and_test.yaml \
              --branch="$BRANCH" \
              --json databaseId,headSha \
              --jq ".[] | select(.headSha == \"$COMMIT_SHA\") | .databaseId" \
              | head -n 1)

            if [ -n "$RUN_ID" ]; then
              echo "Found CI run: $RUN_ID"
              break
            fi
            echo "No matching run found yet, waiting 10s..."
            sleep 10
          done

          if [ -z "$RUN_ID" ]; then
            echo "::error::Timed out waiting for CI run to appear"
            echo "conclusion=timed_out" >> $GITHUB_OUTPUT
            echo "run_id=" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "run_id=$RUN_ID" >> $GITHUB_OUTPUT

          # Watch the run until it completes (streams logs to stdout)
          gh run watch "$RUN_ID" --exit-status || true

          # Get the final conclusion
          CONCLUSION=$(gh run view "$RUN_ID" --json conclusion --jq '.conclusion')
          echo "CI conclusion: $CONCLUSION"
          echo "conclusion=$CONCLUSION" >> $GITHUB_OUTPUT

      - name: Merge to master
        id: merge-to-master
        env:
          GH_TOKEN: ${{ secrets.APIFY_SERVICE_ACCOUNT_GITHUB_TOKEN }}
        if: steps.wait-for-ci.outputs.conclusion == 'success'
        run: |
          BRANCH="${{ steps.branch-name.outputs.BRANCH_NAME }}"
          REPO="${{ github.repository }}"

          echo "CI passed, merging $BRANCH into master..."

          # Attempt the merge via API
          MERGE_RESPONSE=$(gh api "repos/$REPO/merges" \
            -f base=master \
            -f head="$BRANCH" \
            -f commit_message="chore: Update templates for base image: ${{ steps.branch-name.outputs.BASE_IMAGE_FORMATTED }}" \
            2>&1) || {
            echo "::warning::Merge failed: $MERGE_RESPONSE"
            echo "merged=false" >> $GITHUB_OUTPUT
            exit 0
          }

          echo "Merge successful, deleting branch $BRANCH..."
          git push origin --delete "$BRANCH" || echo "::warning::Failed to delete branch $BRANCH"

          echo "merged=true" >> $GITHUB_OUTPUT

      - name: Create or update Pull Request
        env:
          GH_TOKEN: ${{ secrets.APIFY_SERVICE_ACCOUNT_GITHUB_TOKEN }}
        if: |
          steps.commit-and-push.outputs.committed == 'true'
          && steps.merge-to-master.outputs.merged != 'true'
        run: |
          BRANCH="${{ steps.branch-name.outputs.BRANCH_NAME }}"
          CI_CONCLUSION="${{ steps.wait-for-ci.outputs.conclusion }}"
          CI_RUN_ID="${{ steps.wait-for-ci.outputs.run_id }}"

          # Build CI status message for the PR body
          if [ "$CI_CONCLUSION" = "success" ]; then
            CI_STATUS="⚠️ CI passed, but the automatic merge into master did not complete. Please check for merge conflicts, branch protection rules, or permission issues and resolve manually. See workflow logs for details."
          elif [ -n "$CI_RUN_ID" ]; then
            CI_STATUS="❌ CI failed. [View CI run](https://github.com/${{ github.repository }}/actions/runs/$CI_RUN_ID)"
          else
            CI_STATUS="⚠️ CI status unknown (timed out waiting for CI run)."
          fi

          PR_BODY="Automated update of templates for base image \`${{ steps.branch-name.outputs.BASE_IMAGE_FORMATTED }}\`

          **Parameters:**
          - Base Image: \`${{ steps.branch-name.outputs.BASE_IMAGE_FORMATTED }}\`
          - Runtime Version: \`${{ env.DEFAULT_RUNTIME_VERSION }}\`
          - Module Version: \`${{ env.MODULE_VERSION || 'N/A' }}\`

          **CI Status:** $CI_STATUS

          > Generated by [Update Templates](https://github.com/apify/actor-templates/actions/workflows/update-templates.yml) workflow."

          # Check if PR already exists
          PR_EXISTS=$(gh pr list --head "$BRANCH" --base master --json number --jq length)

          if [ "$PR_EXISTS" -eq "0" ]; then
            echo "Creating new PR"
            gh pr create \
              --title "chore: Update templates for base image: ${{ steps.branch-name.outputs.BASE_IMAGE_FORMATTED }}" \
              --body "$PR_BODY" \
              --base master \
              --head "$BRANCH" \
              --reviewer B4nan \
              --reviewer vladfrangu
          else
            echo "PR already exists for branch $BRANCH, updating it"
            gh pr edit "$BRANCH" --body "$PR_BODY"
          fi
