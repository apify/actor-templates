name: Update Templates

on:
  workflow_dispatch:
    inputs:
      base_image:
        description: 'Base image to update'
        required: true
        type: string
      module_version:
        description: 'Playwright or Puppeteer version'
        required: false
        type: string
      default_runtime_version:
        description: 'Default runtime version (example: 24 for node, 3.13 for python)'
        required: false
        type: string

env:
    BRANCH_NAME: ci/${{ inputs.base_image }}

jobs:
  update-templates:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          token: ${{ secrets.APIFY_SERVICE_ACCOUNT_GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Check and manage branch
        run: |
          # Fetch all branches
          git fetch origin

          # Check if branch exists on remote
          if git ls-remote --heads origin "$BRANCH_NAME" | grep -q "$BRANCH_NAME"; then
            echo "Branch $BRANCH_NAME exists, checking it out and resetting to origin/master"
            git checkout "$BRANCH_NAME"
            git reset --hard origin/master
          else
            echo "Branch $BRANCH_NAME does not exist, creating it"
            git checkout -b "$BRANCH_NAME"
          fi

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: 24

      - name: Run update script
        env:
          BASE_IMAGE: ${{ inputs.base_image }}
          DEFAULT_RUNTIME_VERSION: ${{ inputs.default_runtime_version }}
          MODULE_VERSION: ${{ inputs.module_version }}
        run: node ./scripts/actions/update-templates.mts

      - name: Commit and push changes
        run: |
          # Check if there are any changes
          if git diff --quiet && git diff --cached --quiet; then
            echo "No changes to commit"
          else
            git add -A
            git commit -m "chore: Update templates for base image: ${{ inputs.base_image }}"
          fi

          # Force push the branch
          git push --force origin "$BRANCH_NAME"

      - name: Create Pull Request
        env:
          GH_TOKEN: ${{ secrets.APIFY_SERVICE_ACCOUNT_GITHUB_TOKEN }}
        run: |
          # Check if PR already exists
          PR_EXISTS=$(gh pr list --head "$BRANCH_NAME" --base master --json number --jq length)

          if [ "$PR_EXISTS" -eq "0" ]; then
            echo "Creating new PR"
            gh pr create \
              --title "chore: Update templates for base image: ${{ inputs.base_image }}" \
              --body "Automated update of templates for base image \`${{ inputs.base_image }}\`

              **Parameters:**
              - Base Image: \`${{ inputs.base_image }}\`
              - Node Version: \`${{ inputs.default_node_version || 'N/A' }}\`
              - Python Version: \`${{ inputs.default_python_version || 'N/A' }}\`

              This PR was automatically generated by the [Update Templates](https://github.com/apify/actor-templates/actions/workflows/update-templates.yml) workflow." \
              --base master \
              --head "$BRANCH_NAME" \
              --reviewer B4nan \
              --reviewer vladfrangu
          else
            echo "PR already exists for branch $BRANCH_NAME"
          fi

